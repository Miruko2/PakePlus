(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[123],{2898:function(e,t,r){"use strict";r.d(t,{Z:function(){return a}});var s=r(2265),n={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let i=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase().trim(),a=(e,t)=>{let r=(0,s.forwardRef)(({color:r="currentColor",size:a=24,strokeWidth:l=2,absoluteStrokeWidth:c,className:d="",children:o,...u},m)=>(0,s.createElement)("svg",{ref:m,...n,width:a,height:a,stroke:r,strokeWidth:c?24*Number(l)/Number(a):l,className:["lucide",`lucide-${i(e)}`,d].join(" "),...u},[...t.map(([e,t])=>(0,s.createElement)(e,t)),...Array.isArray(o)?o:[o]]));return r.displayName=`${e}`,r}},6264:function(e,t,r){"use strict";r.d(t,{Z:function(){return s}});/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let s=(0,r(2898).Z)("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},1992:function(e,t,r){Promise.resolve().then(r.bind(r,452)),Promise.resolve().then(r.bind(r,6005))},452:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return j}});var s=r(7437),n=r(2265),i=r(5754),a=r(1654),l=r(2926),c=r(7815),d=r(6061),o=r(1657);let u=(0,d.j)("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),m=n.forwardRef((e,t)=>{let{className:r,variant:n,...i}=e;return(0,s.jsx)("div",{ref:t,role:"alert",className:(0,o.cn)(u({variant:n}),r),...i})});m.displayName="Alert";let f=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,s.jsx)("h5",{ref:t,className:(0,o.cn)("mb-1 font-medium leading-none tracking-tight",r),...n})});f.displayName="AlertTitle";let x=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,s.jsx)("div",{ref:t,className:(0,o.cn)("text-sm [&_p]:leading-relaxed",r),...n})});x.displayName="AlertDescription";var h=r(7788),p=r(5858),v=r(6264);function j(){let{user:e}=(0,l.d)(),{notifications:t,unreadCount:r,isLoading:d,refreshNotifications:o}=(0,p.z)(),[u,j]=(0,n.useState)(null),[g,y]=(0,n.useState)(null),[N,b]=(0,n.useState)(!1),[w,_]=(0,n.useState)(!1),{toast:k}=(0,h.pm)(),S=async()=>{if(!e){k({title:"未登录",description:"请先登录后再测试通知功能",variant:"destructive"});return}b(!0),j(null),y(null);try{let{data:t,error:r}=await a.OQ.from("posts").select("id").limit(1);if(r||!t||0===t.length){y("找不到可用的帖子: ".concat((null==r?void 0:r.message)||"无可用帖子创建测试通知")),k({title:"创建通知失败",description:"找不到可用的帖子来创建测试通知",variant:"destructive"}),b(!1);return}let s=t[0].id,{data:n,error:i}=await a.OQ.from("notifications").insert({user_id:e.id,type:"like_post",post_id:s,actor_id:e.id,message:"测试通知 - ".concat(new Date().toLocaleTimeString()),is_read:!1}).select();i?(console.error("创建通知失败:",i),y("创建通知失败: ".concat(i.message)),k({title:"创建通知失败",description:i.message,variant:"destructive"})):(j(n),k({title:"创建通知成功",description:"通知已成功创建，请检查通知铃铛"}),setTimeout(()=>{o()},1e3))}catch(e){console.error("执行出错:",e),y("执行出错: ".concat((null==e?void 0:e.message)||"未知错误")),k({title:"执行出错",description:(null==e?void 0:e.message)||"未知错误",variant:"destructive"})}finally{b(!1)}},C=async()=>{if(e){_(!0);try{await o(),k({title:"刷新通知",description:"通知已更新"})}catch(e){console.error("刷新通知失败:",e),k({title:"刷新失败",description:"更新通知时出错",variant:"destructive"})}finally{_(!1)}}};return(0,s.jsxs)("div",{className:"container py-10",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-6",children:"通知功能测试页面"}),(0,s.jsxs)("div",{className:"grid gap-6 md:grid-cols-2",children:[(0,s.jsxs)(c.Zb,{children:[(0,s.jsxs)(c.Ol,{children:[(0,s.jsx)(c.ll,{children:"当前状态"}),(0,s.jsx)(c.SZ,{children:"用户和通知系统状态"})]}),(0,s.jsxs)(c.aY,{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium",children:"用户状态:"}),e?(0,s.jsxs)("p",{className:"text-green-500",children:["已登录 - ",e.email]}):(0,s.jsx)("p",{className:"text-red-500",children:"未登录"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium",children:"通知数量:"}),d?(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)(v.Z,{className:"h-4 w-4 mr-2 animate-spin"}),(0,s.jsx)("span",{children:"加载中..."})]}):(0,s.jsxs)("p",{children:["总计 ",(null==t?void 0:t.length)||0," 条通知，其中 ",(0,s.jsx)("span",{className:"font-bold text-lime-500",children:r})," 条未读"]})]}),(0,s.jsx)(i.z,{variant:"outline",onClick:C,disabled:d||w||!e,className:"w-full mt-4",children:w?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(v.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"刷新中..."]}):"手动刷新通知"})]})]}),(0,s.jsxs)(c.Zb,{children:[(0,s.jsxs)(c.Ol,{children:[(0,s.jsx)(c.ll,{children:"创建测试通知"}),(0,s.jsx)(c.SZ,{children:"发送一条测试通知到当前账户"})]}),(0,s.jsxs)(c.aY,{children:[g&&(0,s.jsxs)(m,{variant:"destructive",className:"mb-4",children:[(0,s.jsx)(f,{children:"操作失败"}),(0,s.jsx)(x,{children:g})]}),u&&(0,s.jsxs)(m,{className:"mb-4",children:[(0,s.jsx)(f,{children:"操作成功"}),(0,s.jsx)(x,{children:"通知已创建，请检查通知铃铛"})]}),(0,s.jsx)("p",{className:"mb-6 text-sm text-gray-500",children:"点击按钮创建一条测试通知，发送给当前登录用户。创建后，通知铃铛应显示未读通知数量。"})]}),(0,s.jsx)(c.eW,{children:(0,s.jsx)(i.z,{onClick:S,disabled:N||!e,className:"w-full",children:N?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(v.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"创建中..."]}):"创建测试通知"})})]})]}),(0,s.jsxs)(c.Zb,{className:"mt-6",children:[(0,s.jsxs)(c.Ol,{children:[(0,s.jsx)(c.ll,{children:"当前通知列表"}),(0,s.jsx)(c.SZ,{children:"显示最近的通知"})]}),(0,s.jsx)(c.aY,{children:d?(0,s.jsxs)("div",{className:"flex items-center justify-center py-10",children:[(0,s.jsx)(v.Z,{className:"h-6 w-6 mr-2 animate-spin"}),(0,s.jsx)("span",{children:"加载通知中..."})]}):t&&t.length>0?(0,s.jsx)("div",{className:"space-y-3",children:t.map(e=>(0,s.jsxs)("div",{className:"p-4 border rounded-lg ".concat(e.is_read?"bg-gray-50":"bg-lime-50 border-lime-200"),children:[(0,s.jsx)("p",{className:"font-medium",children:e.message}),(0,s.jsxs)("div",{className:"flex justify-between mt-2 text-sm text-gray-500",children:[(0,s.jsxs)("span",{children:["类型: ",e.type]}),(0,s.jsxs)("span",{children:["状态: ",e.is_read?"已读":"未读"]}),(0,s.jsxs)("span",{children:["时间: ",new Date(e.created_at).toLocaleString()]})]})]},e.id))}):(0,s.jsx)("div",{className:"py-10 text-center text-gray-500",children:(0,s.jsx)("p",{children:"暂无通知"})})})]})]})}},7815:function(e,t,r){"use strict";r.d(t,{Ol:function(){return l},SZ:function(){return d},Zb:function(){return a},aY:function(){return o},eW:function(){return u},ll:function(){return c}});var s=r(7437),n=r(2265),i=r(1657);let a=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",r),...n})});a.displayName="Card";let l=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("flex flex-col space-y-1.5 p-6",r),...n})});l.displayName="CardHeader";let c=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("text-2xl font-semibold leading-none tracking-tight",r),...n})});c.displayName="CardTitle";let d=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("text-sm text-muted-foreground",r),...n})});d.displayName="CardDescription";let o=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("p-6 pt-0",r),...n})});o.displayName="CardContent";let u=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("flex items-center p-6 pt-0",r),...n})});u.displayName="CardFooter"},5858:function(e,t,r){"use strict";r.d(t,{J:function(){return d},z:function(){return o}});var s=r(7437),n=r(2265),i=r(2926),a=r(747),l=r(1654);let c=(0,n.createContext)(void 0);function d(e){let{children:t}=e,[r,d]=(0,n.useState)([]),[o,u]=(0,n.useState)(0),[m,f]=(0,n.useState)(!1),{user:x}=(0,i.d)(),h=(0,n.useRef)(null),p=(0,n.useRef)(0),v=(0,n.useRef)(!0),j=async e=>{if(!x)return!1;let t=Date.now();if(t-p.current<3e3||(p.current=t,!v.current))return!1;f(!0);try{let{notifications:t}=await (0,a.gG)(x.id,e);Array.isArray(t)?d(t):(console.error("返回的通知不是数组:",t),d([]));let r=await (0,a.rj)(x.id);return u(r||0),!0}catch(e){return console.error("获取通知失败:",e),d([]),!1}finally{f(!1)}},g=async e=>{await j(e)},y=async()=>{await j()},N=async e=>{if(x)try{await (0,a.Ix)(e,x.id)&&(d(t=>t.map(t=>t.id===e?{...t,is_read:!0}:t)),u(e=>Math.max(0,e-1)))}catch(e){console.error("标记通知已读失败:",e)}},b=async()=>{if(x)try{await (0,a.Go)(x.id)&&(d(e=>e.map(e=>({...e,is_read:!0}))),u(0))}catch(e){console.error("标记所有通知已读失败:",e)}};return(0,n.useEffect)(()=>{let e=()=>{let e="visible"===document.visibilityState;v.current=e,e&&j()};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}},[]),(0,n.useEffect)(()=>{if(!x){d([]),u(0),h.current&&(h.current(),h.current=null);return}let e=function(e,t){let r=null,s=0,n="",i=async function(){let r=arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{let i=Date.now();if(!r&&i-s<5e3)return;s=i;try{(0,a.aY)("profile")}catch(e){}let{notifications:l}=await (0,a.gG)(e),d=c(l);(d!==n||r)&&(n=d,t(l))}catch(e){console.error("获取通知失败:",e)}},c=e=>e&&e.length?e.map(e=>"".concat(e.id,":").concat(e.is_read)).join("|"):"";i(!0);let d=l.OQ.channel("notifications-".concat(e)).on("postgres_changes",{event:"*",schema:"public",table:"notifications",filter:"user_id=eq.".concat(e)},()=>{r&&clearTimeout(r),r=setTimeout(async()=>{await i()},500)}).subscribe(e=>{"SUBSCRIBED"!==e&&i(!0)});return()=>{r&&clearTimeout(r),d.unsubscribe()}}(x.id,e=>{d(e),u(e.filter(e=>!e.is_read).length)});return h.current=e,()=>{h.current&&(h.current(),h.current=null)}},[x]),(0,s.jsx)(c.Provider,{value:{notifications:r,unreadCount:o,isLoading:m,fetchNotifications:g,markAsRead:N,markAllAsRead:b,refreshNotifications:y},children:t})}function o(){let e=(0,n.useContext)(c);if(void 0===e)throw Error("useNotifications must be used within a NotificationProvider");return e}},6005:function(e,t,r){"use strict";function s(e){let{children:t}=e;return t}Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"NoSSR",{enumerable:!0,get:function(){return s}}),r(6491)}},function(e){e.O(0,[870,542,243,426,971,938,744],function(){return e(e.s=1992)}),_N_E=e.O()}]);