"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[485],{2805:function(e,t,n){n.d(t,{F$:function(){return l},Q5:function(){return c},qE:function(){return i}});var a=n(7437),r=n(2265),s=n(1465),o=n(1657);let i=r.forwardRef((e,t)=>{let{className:n,...r}=e;return(0,a.jsx)(s.fC,{ref:t,className:(0,o.cn)("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",n),...r})});i.displayName=s.fC.displayName;let l=r.forwardRef((e,t)=>{let{className:n,...r}=e;return(0,a.jsx)(s.Ee,{ref:t,className:(0,o.cn)("aspect-square h-full w-full",n),...r})});l.displayName=s.Ee.displayName;let c=r.forwardRef((e,t)=>{let{className:n,...r}=e;return(0,a.jsx)(s.NY,{ref:t,className:(0,o.cn)("flex h-full w-full items-center justify-center rounded-full bg-muted",n),...r})});c.displayName=s.NY.displayName},3930:function(e,t,n){n.d(t,{$F:function(){return u},AW:function(){return m},Ju:function(){return f},VD:function(){return h},Xi:function(){return p},h_:function(){return d}});var a=n(7437),r=n(2265),s=n(9625),o=n(7158),i=n(2442),l=n(6369),c=n(1657);let d=s.fC,u=s.xz;s.ZA,s.Uv,s.Tr,s.Ee,r.forwardRef((e,t)=>{let{className:n,inset:r,children:i,...l}=e;return(0,a.jsxs)(s.fF,{ref:t,className:(0,c.cn)("flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",r&&"pl-8",n),...l,children:[i,(0,a.jsx)(o.Z,{className:"ml-auto"})]})}).displayName=s.fF.displayName,r.forwardRef((e,t)=>{let{className:n,...r}=e;return(0,a.jsx)(s.tu,{ref:t,className:(0,c.cn)("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",n),...r})}).displayName=s.tu.displayName;let m=r.forwardRef((e,t)=>{let{className:n,sideOffset:r=4,...o}=e;return(0,a.jsx)(s.Uv,{children:(0,a.jsx)(s.VY,{ref:t,sideOffset:r,className:(0,c.cn)("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",n),...o})})});m.displayName=s.VY.displayName;let p=r.forwardRef((e,t)=>{let{className:n,inset:r,...o}=e;return(0,a.jsx)(s.ck,{ref:t,className:(0,c.cn)("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",r&&"pl-8",n),...o})});p.displayName=s.ck.displayName,r.forwardRef((e,t)=>{let{className:n,children:r,checked:o,...l}=e;return(0,a.jsxs)(s.oC,{ref:t,className:(0,c.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",n),checked:o,...l,children:[(0,a.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,a.jsx)(s.wU,{children:(0,a.jsx)(i.Z,{className:"h-4 w-4"})})}),r]})}).displayName=s.oC.displayName,r.forwardRef((e,t)=>{let{className:n,children:r,...o}=e;return(0,a.jsxs)(s.Rk,{ref:t,className:(0,c.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",n),...o,children:[(0,a.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,a.jsx)(s.wU,{children:(0,a.jsx)(l.Z,{className:"h-2 w-2 fill-current"})})}),r]})}).displayName=s.Rk.displayName;let f=r.forwardRef((e,t)=>{let{className:n,inset:r,...o}=e;return(0,a.jsx)(s.__,{ref:t,className:(0,c.cn)("px-2 py-1.5 text-sm font-semibold",r&&"pl-8",n),...o})});f.displayName=s.__.displayName;let h=r.forwardRef((e,t)=>{let{className:n,...r}=e;return(0,a.jsx)(s.Z0,{ref:t,className:(0,c.cn)("-mx-1 my-1 h-px bg-muted",n),...r})});h.displayName=s.Z0.displayName},8793:function(e,t,n){n.d(t,{Mi:function(){return i},nf:function(){return o},p6:function(){return s}});var a=n(7437),r=n(8861);function s(e){let{size:t="md",color:n="text-lime-500",text:s="加载中",showText:o=!1}=e,i={sm:"w-1.5 h-1.5",md:"w-2 h-2",lg:"w-2.5 h-2.5",xl:"w-3 h-3"}[t],l={initial:{y:0},animate:e=>({y:[0,-10,0],transition:{repeat:1/0,repeatType:"loop",duration:1,ease:"easeInOut",delay:.15*e}})};return(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center ".concat({sm:"h-6",md:"h-8",lg:"h-12",xl:"h-16"}[t]),children:[(0,a.jsx)("div",{className:"flex ".concat({sm:"gap-1.5",md:"gap-2",lg:"gap-3",xl:"gap-4"}[t]," items-center justify-center"),children:[0,1,2].map(e=>(0,a.jsx)(r.E.div,{className:"".concat(i," rounded-full ").concat(n),variants:l,initial:"initial",animate:"animate",custom:e},e))}),o&&(0,a.jsx)("p",{className:"mt-2 ".concat({sm:"text-xs",md:"text-sm",lg:"text-base",xl:"text-lg"}[t]," ").concat(n),children:s})]})}function o(e){let{size:t="md",color:n="text-lime-500",text:s="加载中",showText:o=!1}=e,i={sm:"h-8 w-8",md:"h-12 w-12",lg:"h-16 w-16",xl:"h-20 w-20"}[t],l=n.startsWith("text-")?n.replace("text-","bg-"):n;return(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center",children:[(0,a.jsxs)("div",{className:"relative ".concat(i," flex items-center justify-center"),children:[(0,a.jsx)(r.E.div,{className:"absolute ".concat(i," ").concat(l,"/20 rounded-full"),initial:{scale:.5,opacity:0},animate:{scale:[.5,1.2,.5],opacity:[.2,.6,.2]},transition:{repeat:1/0,duration:2,ease:"easeInOut"}}),(0,a.jsx)(r.E.div,{className:"".concat({sm:"h-4 w-4",md:"h-6 w-6",lg:"h-8 w-8",xl:"h-10 w-10"}[t]," ").concat(l," rounded-full"),animate:{scale:[.8,1,.8],opacity:[.8,1,.8]},transition:{repeat:1/0,duration:1.5,ease:"easeInOut"}})]}),o&&(0,a.jsx)("p",{className:"mt-3 ".concat({sm:"text-xs",md:"text-sm",lg:"text-base",xl:"text-lg"}[t]," ").concat(n),children:s})]})}function i(e){let{size:t="md",color:n="text-lime-500",text:s="加载中",showText:o=!1}=e,i={sm:"w-4 h-5",md:"w-5 h-6",lg:"w-6 h-8",xl:"w-8 h-10"}[t],l=n.startsWith("text-")?n.replace("text-","bg-"):n,c={initial:e=>({opacity:.3,y:0,rotate:15*e,x:3*e}),animate:e=>({opacity:0===e?[.3,1,.3]:[.3,.7,.3],y:[0,-10,0],rotate:[15*e,15*e+5,15*e],x:[3*e,3*e+2,3*e],transition:{repeat:1/0,duration:2,ease:"easeInOut",delay:.2*e}})};return(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center",children:[(0,a.jsx)("div",{className:"relative ".concat({sm:"h-12 w-12",md:"h-16 w-16",lg:"h-20 w-20",xl:"h-24 w-24"}[t]," flex items-center justify-center"),children:[0,1,2].map(e=>(0,a.jsx)(r.E.div,{className:"absolute ".concat(i," ").concat(l," rounded-md shadow-lg"),style:{zIndex:3-e,filter:"brightness(".concat(100-15*e,"%)")},variants:c,initial:"initial",animate:"animate",custom:e},e))}),o&&(0,a.jsx)("p",{className:"mt-3 ".concat({sm:"text-xs",md:"text-sm",lg:"text-base",xl:"text-lg"}[t]," ").concat(n),children:s})]})}},9752:function(e,t,n){n.d(t,{k:function(){return f},o:function(){return p}});var a=n(7437),r=n(2265),s=n(9882),o=n(1654);let i=[],l=0,c=!1,d=0;function u(e,t){switch(t.type){case"LOAD_POSTS":return{...e,posts:t.payload,isLoading:!1,error:null,page:1};case"LOAD_MORE_POSTS":let n=new Set(e.posts.map(e=>e.id)),a=t.payload.filter(e=>!n.has(e.id));return{...e,posts:[...e.posts,...a],page:e.page+1};case"SET_LOADING":return{...e,isLoading:t.payload};case"SET_HAS_MORE":return{...e,hasMore:t.payload};case"SET_PAGE":return{...e,page:t.payload};case"SET_ERROR":return{...e,error:t.payload};case"ADD_POST":return{...e,posts:[t.payload,...e.posts]};case"DELETE_POST":return{...e,posts:e.posts.filter(e=>e.id!==t.payload)};case"UPDATE_POST":return{...e,posts:e.posts.map(e=>e.id===t.payload.id?{...e,...t.payload.updates}:e)};default:return e}}let m=(0,r.createContext)(void 0);function p(e){let{children:t}=e,[n,p]=(0,r.useReducer)(u,{posts:[],isLoading:!0,hasMore:!0,page:0,error:null}),f=async()=>{try{p({type:"SET_LOADING",payload:!0}),p({type:"SET_ERROR",payload:null});let e=Date.now();if(i.length>0&&e-l<6e4&&!c){p({type:"LOAD_POSTS",payload:i}),p({type:"SET_HAS_MORE",payload:i.length>=30}),p({type:"SET_LOADING",payload:!1});return}let t=await (0,s.YL)(0,30);if(0===t.length&&!c&&d<3){d++,c=!0,console.warn("获取帖子为空，尝试重试(".concat(d,"/").concat(3,")...")),setTimeout(()=>{f()},1e3*d);return}t.length>0&&(c=!1,d=0,i=t,l=e),p({type:"LOAD_POSTS",payload:t}),p({type:"SET_HAS_MORE",payload:t.length>=30})}catch(e){console.error("加载帖子失败:",e),p({type:"SET_ERROR",payload:"加载帖子失败，请尝试刷新"}),c=!0,i.length>0&&p({type:"LOAD_POSTS",payload:i})}finally{p({type:"SET_LOADING",payload:!1})}},h=async()=>{c=!1,d=0,i=[],l=0,await f()},_=async(e,t)=>{if(!n.isLoading&&n.hasMore)try{p({type:"SET_LOADING",payload:!0}),p({type:"SET_ERROR",payload:null});let a=e||n.page+1,r=t||30,o=await (0,s.YL)(a,r);if(0===o.length){p({type:"SET_HAS_MORE",payload:!1});return}if(o.length>0){let e=new Set(o.map(e=>e.id));i=[...i.filter(t=>!e.has(t.id)),...o],l=Date.now()}p({type:"LOAD_MORE_POSTS",payload:o}),p({type:"SET_HAS_MORE",payload:o.length>=r})}catch(e){console.error("加载更多帖子失败:",e),p({type:"SET_HAS_MORE",payload:!1})}finally{p({type:"SET_LOADING",payload:!1})}},y=e=>{var t,n,a,r,s;let o={...e,likes:null!==(t=e.likes)&&void 0!==t?t:0,comments:null!==(n=e.comments)&&void 0!==n?n:0,likes_count:null!==(a=e.likes_count)&&void 0!==a?a:0,comments_count:null!==(r=e.comments_count)&&void 0!==r?r:0,username:null!==(s=e.username)&&void 0!==s?s:"用户_".concat(e.user_id.substring(0,6)),imageContent:e.image_url?void 0:["+","X","O","□","△","◇"][Math.floor(6*Math.random())]};i=[o,...i],l=Date.now(),p({type:"ADD_POST",payload:o})},g=e=>{i=i.filter(t=>t.id!==e),p({type:"DELETE_POST",payload:e})},w=(e,t)=>{i=i.map(n=>n.id===e?{...n,...t}:n),p({type:"UPDATE_POST",payload:{id:e,updates:t}})};return(0,r.useEffect)(()=>{f();let e=()=>{Date.now()-l>6e4&&f()};return window.addEventListener("focus",e),()=>{window.removeEventListener("focus",e)}},[]),(0,r.useEffect)(()=>{try{let e=o.OQ.channel("posts-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"posts"},e=>{let t=e.new;n.posts.some(e=>e.id===t.id)||y(t)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"posts"},e=>{let t=e.old.id;g(t)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"posts"},e=>{let t=e.new;w(t.id,t)}).subscribe();return()=>{o.OQ.removeChannel(e)}}catch(e){console.error("设置实时订阅失败:",e)}},[n.posts]),(0,a.jsx)(m.Provider,{value:{state:n,dispatch:p,loadPosts:f,loadMorePosts:_,addPost:y,deletePost:g,updatePost:w,retryLoading:h},children:t})}function f(){let e=(0,r.useContext)(m);if(void 0===e)throw Error("usePosts must be used within a PostsProvider");return e}},9882:function(e,t,n){n.d(t,{aK:function(){return c},YL:function(){return d},wy:function(){return m},Vn:function(){return p}});var a=n(1654);class r{get(e){let t=this.cache[e];return!t||t.expiry<Date.now()?(t&&delete this.cache[e],null):t.data}set(e,t,n){this.cache[e]={data:t,expiry:Date.now()+1e3*n}}delete(e){delete this.cache[e]}clear(){this.cache={}}clearExpired(){let e=Date.now();Object.keys(this.cache).forEach(t=>{this.cache[t].expiry<e&&delete this.cache[t]})}constructor(){this.cache={}}}let s=new r;function o(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:60;return async function(){for(var a=arguments.length,r=Array(a),o=0;o<a;o++)r[o]=arguments[o];let i="".concat(t,":").concat(JSON.stringify(r)),l=s.get(i);if(null!==l)return l;let c=await e(...r);return s.set(i,c,n),c}}setInterval(()=>{s.clearExpired()},6e4),window.clearSupabaseCache=function(){s.clear();try{Object.keys(sessionStorage).forEach(e=>{(e.startsWith("supabase_")||e.startsWith("posts_")||e.startsWith("comments_"))&&sessionStorage.removeItem(e)})}catch(e){console.warn("清理 sessionStorage 失败:",e)}try{Object.keys(localStorage).forEach(e=>{(e.startsWith("cache_")||e.startsWith("posts_")||e.startsWith("comments_"))&&localStorage.removeItem(e)})}catch(e){console.warn("清理 localStorage 失败:",e)}},window.smartClearCache=function(e){s.clearExpired()};let i=new Map;function l(){o&&o.cache&&o.cache.clear()}async function c(e,t,n,r){try{var o;let i={post_id:e,user_id:t,content:n.trim(),parent_id:r||null,created_at:new Date().toISOString()},{data:l,error:c}=await a.OQ.from("comments").insert([i]).select("\n        id,\n        content,\n        created_at,\n        user_id,\n        parent_id,\n        post_id,\n        profiles:user_id (\n          id,\n          username,\n          avatar_url\n        )\n      ").single();if(c)throw c;s.delete('comments:["'.concat(e,'"]')),s.delete('post_stats:["'.concat(e,'"]'));let d=l.profiles;return{...l,username:Array.isArray(d)?null===(o=d[0])||void 0===o?void 0:o.username:(null==d?void 0:d.username)||"匿名用户",user:Array.isArray(d)?d[0]:d||null,replies:[],likes_count:0}}catch(e){throw e}}setInterval(()=>{let e=Date.now();for(let[t,n]of i.entries())n.expiry<=e&&i.delete(t)},3e5),o(async()=>{try{let{data:e,error:t}=await a.OQ.from("posts").select("\n          id,\n          title,\n          content,\n          description,\n          category,\n          image_url,\n          image_ratio,\n          created_at,\n          user_id,\n          likes:likes(count),\n          comments:comments(count)\n        ").order("created_at",{ascending:!1}).limit(1e3);if(t)return console.error("❌ 获取帖子失败:",t),[];if(!e||0===e.length)return console.warn("⚠️ 没有获取到任何帖子数据"),[];let n=e.map(e=>e.user_id).filter((e,t,n)=>e&&n.indexOf(e)===t),r=new Map;if(n.length>0)try{let{data:e}=await a.OQ.from("user_profiles").select("user_id, username").in("user_id",n);e&&e.length>0&&e.forEach(e=>{e.user_id&&e.username&&r.set(e.user_id,e.username)})}catch(e){console.warn("获取user_profiles失败:",e)}return e.map(e=>{try{let t=e.image_ratio||1;t=Math.min(Math.max(t,.5),2);let n=0,a=0;try{if(e.likes&&e.likes.length>0){let t=e.likes[0].count;n="string"==typeof t?parseInt(t):"number"==typeof t?t:0}}catch(e){console.warn("解析点赞数出错:",e)}try{if(e.comments&&e.comments.length>0){let t=e.comments[0].count;a="string"==typeof t?parseInt(t):"number"==typeof t?t:0}}catch(e){console.warn("解析评论数出错:",e)}let s=r.get(e.user_id)||"用户_".concat(e.user_id.substring(0,6));return{id:e.id,user_id:e.user_id,title:e.title,content:e.content,description:e.description,category:e.category,image_url:e.image_url,image_ratio:t,created_at:e.created_at,likes:0,comments:0,likes_count:n,comments_count:a,username:s,imageContent:e.image_url?void 0:["+","X","O","□","△","◇"][Math.floor(6*Math.random())]}}catch(t){return console.error("处理单个帖子时出错:",t),{id:e.id||"unknown",user_id:e.user_id||"unknown",title:e.title||"帖子标题加载错误",content:e.content||"",description:e.description||"",category:e.category||"其他",created_at:e.created_at||new Date().toISOString(),likes:0,comments:0,likes_count:0,comments_count:0,username:"用户_未知",imageContent:"X"}}}).filter(e=>null!==e)}catch(e){return console.error("❌ 获取帖子失败:",e),[]}},"all-posts",60),o(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50;try{let s=e*t,{data:o,error:i}=await a.OQ.from("posts").select("\n          id,\n          title,\n          content,\n          description,\n          category,\n          image_url,\n          image_ratio,\n          created_at,\n          user_id,\n          likes:likes(count),\n          comments:comments(count)\n        ").order("created_at",{ascending:!1}).range(s,s+t-1);if(i)throw i;let l=o.map(e=>e.user_id).filter((e,t,n)=>e&&n.indexOf(e)===t),c={};if(l.length>0){let{data:e,error:t}=await a.OQ.from("user_profiles").select("user_id, username").in("user_id",l);!t&&e&&(c=e.reduce((e,t)=>(e[t.user_id]=t,e),{}))}let d={};if(l.length>0){let{data:e,error:t}=await a.OQ.from("profiles").select("id, username").in("id",l);!t&&e&&(d=e.reduce((e,t)=>(t.username&&!t.username.includes("@")&&(e[t.id]=t),e),{}))}let u={};for(let e of l)try{var n,r;let{data:t}=await a.OQ.auth.getUser(e);(null==t?void 0:null===(r=t.user)||void 0===r?void 0:null===(n=r.user_metadata)||void 0===n?void 0:n.username)&&(u[e]=t.user.user_metadata.username)}catch(e){}return(o||[]).map(e=>{var t,n,a,r;let s="";return s=(null===(t=c[e.user_id])||void 0===t?void 0:t.username)?c[e.user_id].username:u[e.user_id]?u[e.user_id]:(null===(n=d[e.user_id])||void 0===n?void 0:n.username)?d[e.user_id].username:"用户_"+e.user_id.substring(0,6),{...e,image_ratio:Math.min(Math.max(e.image_ratio||1,.5),2),likes_count:(null===(a=e.likes[0])||void 0===a?void 0:a.count)||0,comments_count:(null===(r=e.comments[0])||void 0===r?void 0:r.count)||0,username:s,imageContent:e.image_url?void 0:["+","X","O","□","△","◇"][Math.floor(6*Math.random())]}})}catch(e){throw e}},"posts_paginated",30),o(async(e,t)=>{if(!t||0===e.length)return{};try{let{data:n,error:r}=await a.OQ.from("likes").select("post_id").eq("user_id",t).in("post_id",e);if(r)throw r;let s=new Set((n||[]).map(e=>e.post_id));return e.reduce((e,t)=>(e[t]=s.has(t),e),{})}catch(e){return{}}},"multiple_likes",60),o(async e=>{try{let[t,n]=await Promise.all([a.OQ.from("likes").select("*",{count:"exact",head:!0}).eq("post_id",e),a.OQ.from("comments").select("*",{count:"exact",head:!0}).eq("post_id",e)]);return{likes_count:t.count||0,comments_count:n.count||0}}catch(e){return{likes_count:0,comments_count:0}}},"post_stats",30),window.clearSupabaseCache=l,o(async e=>{try{let{data:t,error:n}=await a.OQ.from("comments").select("\n          id,\n          content,\n          created_at,\n          user_id,\n          parent_id,\n          post_id,\n          profiles:user_id (\n            id,\n            username,\n            avatar_url\n          )\n        ").eq("post_id",e).order("created_at",{ascending:!1});if(n)throw n;return function(e){let t=new Map,n=[];return e.forEach(e=>{let n=Array.isArray(e.profiles)?e.profiles[0]:e.profiles;t.set(e.id,{...e,username:(null==n?void 0:n.username)||"匿名用户",user:n||null,replies:[]})}),t.forEach(e=>{if(e.parent_id){let n=t.get(e.parent_id);n&&n.replies.push(e)}else n.push(e)}),n}(t||[])}catch(e){throw e}},"comments",30),window.clearSupabaseCache=l;let d=o(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30;try{let{data:n,error:r}=await a.OQ.from("pinned_posts").select("post_id").order("pinned_at",{ascending:!1});r&&console.error("❌ 获取置顶帖子ID失败:",r);let s=0===e&&(null==n?void 0:n.length)||0,o=Math.max(0,t-s),i=e*t-(e>0?s:0);if(e>0||!(null==n?void 0:n.length)){let{data:e,error:t}=await a.OQ.from("posts").select("\n            id,\n            title,\n            content,\n            description,\n            category,\n            image_url,\n            image_ratio,\n            created_at,\n            user_id,\n            likes:likes(count),\n            comments:comments(count)\n          ").order("created_at",{ascending:!1}).range(i,i+o-1);if(t)return console.error("❌ 获取普通帖子失败:",t),[];return await u(e)}let l=n.map(e=>e.post_id),[c,d]=await Promise.all([a.OQ.from("posts").select("\n            id,\n            title,\n            content,\n            description,\n            category,\n            image_url,\n            image_ratio,\n            created_at,\n            user_id,\n            likes:likes(count),\n            comments:comments(count)\n          ").in("id",l),a.OQ.from("posts").select("\n            id,\n            title,\n            content,\n            description,\n            category,\n            image_url,\n            image_ratio,\n            created_at,\n            user_id,\n            likes:likes(count),\n            comments:comments(count)\n          ").not("id","in","(".concat(l.join(","),")")).order("created_at",{ascending:!1}).limit(o)]);c.error&&console.error("❌ 获取置顶帖子详情失败:",c.error),d.error&&console.error("❌ 获取普通帖子失败:",d.error);let m=c.data||[],p=await u(m,!0),f=d.data||[],h=await u(f);return[...p,...h]}catch(e){return console.error("❌ 获取帖子(含置顶)失败:",e),[]}},e=>"posts-with-pinned-page-".concat(e[0],"-limit-").concat(e[1]),30);async function u(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e||!e.length)return[];let n=e.map(e=>e.user_id).filter((e,t,n)=>e&&n.indexOf(e)===t),r=new Map;if(n.length>0)try{let{data:e}=await a.OQ.from("user_profiles").select("user_id, username").in("user_id",n);e&&e.length>0&&e.forEach(e=>{e.user_id&&e.username&&r.set(e.user_id,e.username)})}catch(e){console.warn("获取user_profiles失败:",e)}return e.map(e=>{try{let n=e.image_ratio||1;n=Math.min(Math.max(n,.5),2);let a=0,s=0;try{if(e.likes&&e.likes.length>0){let t=e.likes[0].count;a="string"==typeof t?parseInt(t):"number"==typeof t?t:0}}catch(e){console.warn("解析点赞数出错:",e)}try{if(e.comments&&e.comments.length>0){let t=e.comments[0].count;s="string"==typeof t?parseInt(t):"number"==typeof t?t:0}}catch(e){console.warn("解析评论数出错:",e)}let o=r.get(e.user_id)||"用户_".concat(e.user_id.substring(0,6));return{id:e.id,user_id:e.user_id,title:e.title,content:e.content,description:e.description,category:e.category,image_url:e.image_url,image_ratio:n,created_at:e.created_at,likes:0,comments:0,likes_count:a,comments_count:s,username:o,imageContent:e.image_url?void 0:["+","X","O","□","△","◇"][Math.floor(6*Math.random())],isPinned:t}}catch(n){return console.error("处理单个帖子时出错:",n),{id:e.id||"unknown",user_id:e.user_id||"unknown",title:e.title||"帖子标题加载错误",content:e.content||"",description:e.description||"",category:e.category||"其他",created_at:e.created_at||new Date().toISOString(),likes:0,comments:0,likes_count:0,comments_count:0,username:"用户_未知",imageContent:"X",isPinned:t}}})}async function m(e){try{let{data:t,error:n}=await a.OQ.from("pinned_posts").insert([{post_id:e}]);if(n)return console.error("❌ 置顶帖子失败:",n),!1;return f(),!0}catch(e){return console.error("❌ 置顶帖子失败:",e),!1}}async function p(e){try{let{data:t,error:n}=await a.OQ.from("pinned_posts").delete().eq("post_id",e);if(n)return console.error("❌ 取消置顶帖子失败:",n),!1;return f(),!0}catch(e){return console.error("❌ 取消置顶帖子失败:",e),!1}}function f(){Object.keys(s).filter(e=>e.startsWith("posts-with-pinned")).forEach(e=>s.delete(e))}}}]);