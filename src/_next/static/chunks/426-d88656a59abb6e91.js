"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[426],{2926:function(e,t,r){r.d(t,{C:function(){return c},d:function(){return l}});var a=r(7437),n=r(2265),s=r(1654),i=r(5083);let o=(0,n.createContext)({user:null,isAdmin:!1,loading:!0,signIn:async()=>({error:null}),signUp:async()=>({error:null,data:null}),signOut:async()=>{}}),l=()=>(0,n.useContext)(o),u=["99ccec1d-b06d-4019-8ad1-456fb95ac90c"],c=e=>{let{children:t}=e,[r,l]=(0,n.useState)(null),[c,d]=(0,n.useState)(!0),{toast:m}=(0,i.pm)(),f=!!r&&u.includes(r.id);(0,n.useEffect)(()=>{let e=!0,t=async()=>{try{let{data:{session:t},error:r}=await s.OQ.auth.getSession();r&&console.error("❌ SimpleAuth: 获取会话失败:",r.message),e&&((null==t?void 0:t.user)?l(t.user):l(null),d(!1))}catch(t){console.error("\uD83D\uDCA5 SimpleAuth: 初始化失败:",t.message),e&&(l(null),d(!1))}},r=setTimeout(()=>{e&&c&&(console.warn("⚠️ SimpleAuth: 初始化超时，强制结束loading状态"),d(!1))},1e3);return t().finally(()=>{clearTimeout(r)}),()=>{e=!1,clearTimeout(r)}},[]),(0,n.useEffect)(()=>{let{data:{subscription:e}}=s.OQ.auth.onAuthStateChange(async(e,t)=>{(null==t?void 0:t.user)?l(t.user):l(null),d(!1)});return()=>{e.unsubscribe()}},[]);let _=async(e,t)=>{try{var r;let{data:a,error:n}=await s.OQ.auth.signInWithPassword({email:e,password:t});if(n)return console.error("❌ SimpleAuth: 登录失败:",n.message),m({title:"登录失败",description:n.message,variant:"destructive"}),{error:n};return(null===(r=a.session)||void 0===r?void 0:r.user)&&m({title:"登录成功",description:"欢迎回来！"}),{error:null}}catch(e){return console.error("\uD83D\uDCA5 SimpleAuth: 登录异常:",e.message),m({title:"登录失败",description:e.message||"登录过程中发生错误",variant:"destructive"}),{error:e}}},h=async(e,t,r)=>{try{let{data:a,error:n}=await s.OQ.auth.signUp({email:e,password:t,options:{data:{username:r}}});if(n)return console.error("❌ SimpleAuth: 注册失败:",n.message),m({title:"注册失败",description:n.message,variant:"destructive"}),{error:n,data:null};if(!a.user)return console.warn("⚠️ SimpleAuth: 注册成功但未返回用户数据"),{error:null,data:a};try{let{data:e,error:t}=await s.OQ.from("user_profiles").insert([{user_id:a.user.id,username:r}]).select().single();t&&console.error("❌ SimpleAuth: 创建user_profiles记录失败:",t.message)}catch(e){console.error("❌ SimpleAuth: 创建user_profiles异常:",e)}try{let{data:e,error:t}=await s.OQ.from("profiles").insert([{id:a.user.id,username:r,updated_at:new Date().toISOString()}]).select().single();t&&console.error("❌ SimpleAuth: 创建profiles记录失败:",t.message)}catch(e){console.error("❌ SimpleAuth: 创建profiles异常:",e)}try{let{error:e}=await s.OQ.auth.updateUser({data:{username:r,displayName:r}});e&&console.warn("⚠️ SimpleAuth: 更新用户元数据失败:",e.message)}catch(e){console.error("❌ SimpleAuth: 更新用户元数据异常:",e)}return m({title:"注册成功",description:"您的账户已成功创建"}),{data:a,error:null}}catch(e){return console.error("\uD83D\uDCA5 SimpleAuth: 注册异常:",e.message),m({title:"注册失败",description:e.message||"注册过程中发生错误",variant:"destructive"}),{error:e,data:null}}},p=async()=>{try{l(null);let{error:e}=await s.OQ.auth.signOut();e&&console.error("❌ SimpleAuth: 登出失败:",e.message),["sb-session","sb-https-session","sb-auth-token","sb-https-auth-token","supabase.auth.token","supabase:auth:token","auth-session","auth-user","session-data","user-data"].forEach(e=>{try{localStorage.removeItem(e),sessionStorage.removeItem(e)}catch(t){console.warn("清除键".concat(e,"失败:"),t)}});try{for(let e of document.cookie.split(";")){let t=e.split("=")[0].trim();(t.includes("sb-")||t.includes("supabase")||t.includes("auth"))&&(document.cookie="".concat(t,"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/;"))}}catch(e){console.warn("清除cookie失败:",e)}await new Promise(e=>setTimeout(e,100)),m({title:"已退出登录",description:"您已成功退出登录"})}catch(e){console.error("\uD83D\uDCA5 SimpleAuth: 登出异常:",e.message),l(null)}};return(0,a.jsx)(o.Provider,{value:{user:r,isAdmin:f,loading:c,signIn:_,signUp:h,signOut:p},children:t})}},747:function(e,t,r){r.d(t,{Ir:function(){return g},Mf:function(){return O},qb:function(){return u},aR:function(){return v},li:function(){return w},rj:function(){return m},gG:function(){return d},xG:function(){return S},n9:function(){return h},Go:function(){return _},Ix:function(){return f},aY:function(){return l},Sv:function(){return y},Gb:function(){return b},Z6:function(){return p}});var a=r(1654);let n={pendingPosts:new Map,listeners:new Set};function s(e){e&&e.id&&(n.pendingPosts.set(e.id,e),function(){let e=Array.from(n.pendingPosts.values());n.listeners.forEach(t=>{try{t(e)}catch(e){}})}())}let i=new Map,o=new Map;function l(e,t){if("all"===e){i.clear(),o.clear();return}if("profile"===e&&t){o.delete(t);return}if(t)for(let r of i.keys())"post"===e&&r.startsWith("".concat(t,":"))?i.delete(r):"comment"===e&&r.startsWith("comment:".concat(t,":"))&&i.delete(r)}async function u(e){let{title:t,content:r,description:n,category:i,image_url:o,image_ratio:u}=e,c=new Promise((e,t)=>setTimeout(()=>t(Error("数据库连接超时")),25e3));try{var d,m,f,_,h,p,v,w,g,y,O,S;let e="",b=null;try{let{data:t}=await Promise.race([a.OQ.auth.getSession(),new Promise((e,t)=>setTimeout(()=>t(Error("会话获取超时")),8e3))]);if(null==t?void 0:null===(f=t.session)||void 0===f?void 0:null===(m=f.user)||void 0===m?void 0:m.id)e=t.session.user.id,b=t.session;else for(let t of["sb-https-session","sb-session","firefly-session-data","last-known-user-id"]){if(e)break;let r=localStorage.getItem(t);if(r&&"undefined"!==r&&"null"!==r)try{if("last-known-user-id"===t){e=r;break}let a=JSON.parse(r);if(null==a?void 0:null===(_=a.user)||void 0===_?void 0:_.id){e=a.user.id,(null===(h=window.httpsDebug)||void 0===h?void 0:h.refresh)&&window.httpsDebug.refresh().catch(()=>{});break}}catch(e){}}}catch(r){let t=localStorage.getItem("last-known-user-id");t&&(e=t)}if(!e)throw Error("未登录或会话已过期，请重新登录");let Q=(null==t?void 0:t.trim())||"无标题",k=(null==r?void 0:r.trim())||"无内容",q=(null==n?void 0:n.trim())||"",I=(null==i?void 0:i.trim())||"general",A=u||1;if(b&&b.access_token)try{await a.OQ.auth.setSession(b)}catch(e){}let E=a.OQ.from("posts").insert([{title:Q,content:k,description:q,category:I,image_url:o||null,image_ratio:A,user_id:e,likes:0,comments:0}]).select(),{data:D,error:C}=await Promise.race([E,c]);if(C){if("PGRST301"===C.code||(null===(p=C.message)||void 0===p?void 0:p.includes("timeout")))throw Error("数据库连接超时，请检查网络连接");if("23505"===C.code)throw Error("帖子创建冲突，请稍后重试");if((null===(v=C.message)||void 0===v?void 0:v.includes("JWT"))||(null===(w=C.message)||void 0===w?void 0:w.includes("auth"))||(null===(g=C.message)||void 0===g?void 0:g.includes("认证"))){if(null===(y=window.httpsDebug)||void 0===y?void 0:y.refresh)try{await window.httpsDebug.refresh();let t=await a.OQ.from("posts").insert([{title:Q,content:k,description:q,category:I,image_url:o||null,image_ratio:A,user_id:e,likes:0,comments:0}]).select();if(!t.error){{let e={...null===(O=t.data)||void 0===O?void 0:O[0],likes_count:0,comments_count:0,username:"刚刚发布",imageContent:(null===(S=t.data)||void 0===S?void 0:S[0].image_url)?void 0:["+","X","O","□","△","◇"][Math.floor(6*Math.random())]};s(e);let r=new CustomEvent("postCreated",{detail:{post:e}});window.dispatchEvent(r)}return t.data}}catch(e){console.error("重试失败:",e)}throw Error("登录已过期，请重新登录")}throw Error(C.message||"数据库操作失败")}try{localStorage.setItem("last-known-user-id",e),localStorage.setItem("last-session-time",Date.now().toString())}catch(e){}if((null==D?void 0:null===(d=D[0])||void 0===d?void 0:d.id)&&l("post",D[0].id),D&&D[0]){let e={...D[0],likes_count:0,comments_count:0,username:"刚刚发布",imageContent:D[0].image_url?void 0:["+","X","O","□","△","◇"][Math.floor(6*Math.random())]};s(e);let t=new CustomEvent("postCreated",{detail:{post:e}});window.dispatchEvent(t)}return D}catch(e){if(console.error("创建帖子错误:",e),"数据库连接超时"===e.message)throw Error("网络连接不稳定，请稍后重试");if(e.message.includes("网络"))throw Error("网络连接异常，请检查网络后重试");throw e}}async function c(e){let{userId:t,type:r,postId:n,commentId:s,actorId:i,message:o}=e;try{if(t===i)return null;if("like_post"===r&&!n)return console.error("通知创建失败: like_post类型必须提供postId"),null;if("comment_post"===r&&!n)return console.error("通知创建失败: comment_post类型必须提供postId"),null;if("like_comment"===r&&!s)return console.error("通知创建失败: like_comment类型必须提供commentId"),null;let{data:e,error:l}=await a.OQ.from("notifications").insert({user_id:t,type:r,post_id:n,comment_id:s,actor_id:i,message:o,is_read:!1,created_at:new Date().toISOString()}).select().single();if(l)throw console.error("数据库创建通知失败:",l),l;return e}catch(e){return console.error("创建通知失败:",e),null}}async function d(e){let{limit:t=20,offset:r=0,onlyUnread:n=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{let s=a.OQ.from("notifications").select("*").eq("user_id",e).order("created_at",{ascending:!1}).range(r,r+t-1);n&&(s=s.eq("is_read",!1));let{data:i,error:o,count:l}=await s;if(o)throw o;return{notifications:await Promise.all((i||[]).map(async e=>{let t=null,r=null,n=null;if(e.actor_id){t={username:"",avatar_url:null};try{let{data:r}=await a.OQ.from("user_profiles").select("username, avatar_url").eq("user_id",e.actor_id).maybeSingle();(null==r?void 0:r.username)&&(t.username=r.username,r.avatar_url&&(t.avatar_url=r.avatar_url))}catch(e){console.error("获取user_profiles失败:",e)}if(!t.username)try{var s,i,o;let{data:r}=await a.OQ.auth.getUser(e.actor_id);if(null==r?void 0:null===(i=r.user)||void 0===i?void 0:null===(s=i.user_metadata)||void 0===s?void 0:s.username)t.username=r.user.user_metadata.username,r.user.user_metadata.avatar_url&&(t.avatar_url=r.user.user_metadata.avatar_url);else if(null==r?void 0:null===(o=r.user)||void 0===o?void 0:o.email){let e=r.user.email.split("@")[0];e&&(t.username=e)}}catch(e){console.error("获取auth.user元数据失败:",e)}if(!t.username)try{let{data:r}=await a.OQ.from("profiles").select("username, avatar_url").eq("id",e.actor_id).maybeSingle();if(null==r?void 0:r.username){if(r.username.includes("@")){let e=r.username.split("@")[0];t.username=e}else t.username=r.username;r.avatar_url&&(t.avatar_url=r.avatar_url)}}catch(e){console.error("获取profiles失败:",e)}t.username||(t.username="用户_"+e.actor_id.substring(0,6)),t.username&&e.message&&e.message.includes("@")&&(e.message=e.message.replace(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/,t.username))}if(e.post_id){let{data:t}=await a.OQ.from("posts").select("title").eq("id",e.post_id).maybeSingle();r=t}if(e.comment_id){let{data:t}=await a.OQ.from("comments").select("content").eq("id",e.comment_id).maybeSingle();n=t}return{...e,actor:t,post:r,comment:n}})),count:l}}catch(e){return console.error("获取通知失败:",e),{notifications:[],count:0}}}async function m(e){try{let{count:t,error:r}=await a.OQ.from("notifications").select("*",{count:"exact",head:!0}).eq("user_id",e).eq("is_read",!1);if(r)throw r;return t||0}catch(e){return console.error("获取未读通知数量失败:",e),0}}async function f(e,t){try{let{data:r,error:n}=await a.OQ.from("notifications").update({is_read:!0}).eq("id",e).eq("user_id",t);if(n)throw n;return!0}catch(e){return console.error("标记通知已读失败:",e),!1}}async function _(e){try{let{error:t}=await a.OQ.from("notifications").update({is_read:!0}).eq("user_id",e).eq("is_read",!1);if(t)throw t;return!0}catch(e){return console.error("标记所有通知已读失败:",e),!1}}async function h(e,t){try{let o="".concat(e,":").concat(t);i.delete(o);let{data:u,error:d}=await a.OQ.from("likes").insert([{post_id:e,user_id:t,created_at:new Date().toISOString()}]).select();if(d)throw d;l("post",e);let{data:m,error:f}=await a.OQ.from("posts").select("user_id, title").eq("id",e).single();if(f)throw f;if(m&&m.user_id!==t){let i="";try{let{data:e}=await a.OQ.from("user_profiles").select("username").eq("user_id",t).maybeSingle();(null==e?void 0:e.username)&&(i=e.username)}catch(e){console.error("获取user_profiles失败:",e)}if(!i)try{var r,n,s;let{data:e}=await a.OQ.auth.getUser(t);(null==e?void 0:null===(n=e.user)||void 0===n?void 0:null===(r=n.user_metadata)||void 0===r?void 0:r.username)?i=e.user.user_metadata.username:(null==e?void 0:null===(s=e.user)||void 0===s?void 0:s.email)&&(i=e.user.email.split("@")[0])}catch(e){console.error("获取auth.user元数据失败:",e)}if(!i)try{let{data:e}=await a.OQ.from("profiles").select("username").eq("id",t).maybeSingle();(null==e?void 0:e.username)&&(i=e.username)}catch(e){console.error("获取profiles失败:",e)}if(i||(i="用户_"+t.substring(0,6)),i.includes("@")){let e=i.split("@")[0];e&&(i=e)}await c({userId:m.user_id,type:"like_post",postId:e,actorId:t,message:"".concat(i,' 赞了你的帖子 "').concat(m.title,'"')})}return null==u?void 0:u[0]}catch(e){throw console.error("点赞失败:",e),e}}async function p(e,t){try{let r="".concat(e,":").concat(t);i.delete(r);let{error:n}=await a.OQ.from("likes").delete().eq("post_id",e).eq("user_id",t);if(n)throw n;return l("post",e),!0}catch(e){throw console.error("取消点赞失败:",e),e}}async function v(e){try{let{count:t,error:r}=await a.OQ.from("comment_likes").select("*",{count:"exact",head:!0}).eq("comment_id",e);if(r)throw r;return t||0}catch(e){return console.error("获取评论点赞数量失败:",e),0}}async function w(e){try{let{data:t,error:r}=await a.OQ.from("comments").select("\n        id,\n        content,\n        created_at,\n        user_id,\n        parent_id,\n        post_id\n      ").eq("post_id",e).order("created_at",{ascending:!1});if(r)throw console.error("获取评论错误:",r),r;if(!t||0===t.length)return[];let n=t.map(e=>e.id),s=[...new Set(t.map(e=>e.user_id).filter(Boolean))],[i,o]=await Promise.all([Promise.all(n.map(async e=>{let{count:t}=await a.OQ.from("comment_likes").select("*",{count:"exact",head:!0}).eq("comment_id",e);return{commentId:e,likes:t||0}})),(async()=>{let e=new Map,[t,r]=await Promise.allSettled([a.OQ.from("profiles").select("id, username, avatar_url").in("id",s),a.OQ.from("user_profiles").select("user_id, username, avatar_url").in("user_id",s)]);return"fulfilled"===t.status&&t.value.data&&t.value.data.forEach(t=>{e.set(t.id,{id:t.id,username:t.username||"匿名用户",avatar_url:t.avatar_url})}),"fulfilled"===r.status&&r.value.data&&r.value.data.forEach(t=>{e.set(t.user_id,{id:t.user_id,username:t.username||"匿名用户",avatar_url:t.avatar_url})}),s.forEach(t=>{e.has(t)||e.set(t,{id:t,username:"用户_".concat(t.substring(0,6)),avatar_url:null})}),e})()]),l=new Map;i.forEach(e=>{l.set(e.commentId,e.likes)});let u=t.map(e=>{let t=o.get(e.user_id);return{...e,username:(null==t?void 0:t.username)||"匿名用户",user:t||{id:e.user_id,username:"匿名用户",avatar_url:null},likes_count:l.get(e.id)||0,likes:l.get(e.id)||0}});return function(e){let t=new Map,r=[];return e.forEach(e=>{t.set(e.id,{...e,replies:[]})}),t.forEach(e=>{if(e.parent_id){let a=t.get(e.parent_id);a?a.replies.push(e):r.push(e)}else r.push(e)}),r}(u)}catch(e){throw console.error("获取评论失败:",e),e}}async function g(e,t,r,n){try{let{data:o,error:l}=await a.OQ.from("comments").insert([{post_id:e,user_id:t,content:r,parent_id:n||null,created_at:new Date().toISOString()}]).select("\n        id,\n        content,\n        created_at,\n        user_id,\n        parent_id,\n        post_id\n      ").single();if(l)throw l;let{data:u}=await a.OQ.from("profiles").select("username, avatar_url").eq("id",t).maybeSingle(),d={...o,username:(null==u?void 0:u.username)||"匿名用户",user:u?{id:t,username:u.username||"匿名用户",avatar_url:u.avatar_url}:null,replies:[],likes_count:0},m="";try{let{data:e}=await a.OQ.from("user_profiles").select("username").eq("user_id",t).maybeSingle();(null==e?void 0:e.username)&&(m=e.username)}catch(e){}if(!m)try{var s,i;let{data:e}=await a.OQ.auth.getUser(t);(null==e?void 0:null===(i=e.user)||void 0===i?void 0:null===(s=i.user_metadata)||void 0===s?void 0:s.username)&&(m=e.user.user_metadata.username)}catch(e){}if(!m&&(null==u?void 0:u.username)&&(m=u.username),m||(m="用户_"+t.substring(0,6)),m.includes("@")){let e=m.split("@")[0];e&&(m=e)}if(n){let{data:s}=await a.OQ.from("comments").select("user_id").eq("id",n).single();s&&s.user_id!==t&&await c({userId:s.user_id,type:"comment_post",postId:e,actorId:t,message:"".concat(m,' 回复了你的评论: "').concat(r.substring(0,30)).concat(r.length>30?"...":"",'"')})}else{let{data:n}=await a.OQ.from("posts").select("user_id, title").eq("id",e).maybeSingle();n&&n.user_id!==t&&await c({userId:n.user_id,type:"comment_post",postId:e,actorId:t,message:"".concat(m,' 评论了你的帖子 "').concat(n.title,'": "').concat(r.substring(0,30)).concat(r.length>30?"...":"",'"')})}return d}catch(e){throw console.error("添加评论失败:",e),e}}function y(e,t){w(e).then(t).catch(console.error);let r=a.OQ.channel("comments-channel-".concat(e)).on("postgres_changes",{event:"*",schema:"public",table:"comments",filter:"post_id=eq.".concat(e)},async r=>{try{let r=await w(e);t(r)}catch(e){console.error("获取更新的评论失败:",e)}}).subscribe();return()=>{r.unsubscribe()}}async function O(e,t){if(!t||!e)return!1;try{let r="comment:".concat(e,":").concat(t);if(i.has(r))return i.get(r);let{data:n,error:s}=await a.OQ.from("comment_likes").select("id").eq("comment_id",e).eq("user_id",t).maybeSingle(),o=!!n;return i.set(r,o),o}catch(e){return console.error("检查评论点赞状态异常:",e),!1}}async function S(e,t){try{let s="comment:".concat(e,":").concat(t);i.delete(s);let{data:o,error:u}=await a.OQ.from("comment_likes").insert([{comment_id:e,user_id:t,created_at:new Date().toISOString()}]).select();if(u)throw u;l("comment",e);let{data:d}=await a.OQ.from("comments").select("user_id, content, post_id").eq("id",e).single();if(d&&d.user_id!==t){let s="";try{let{data:e}=await a.OQ.from("user_profiles").select("username").eq("user_id",t).maybeSingle();(null==e?void 0:e.username)&&(s=e.username)}catch(e){}if(!s)try{var r,n;let{data:e}=await a.OQ.auth.getUser(t);(null==e?void 0:null===(n=e.user)||void 0===n?void 0:null===(r=n.user_metadata)||void 0===r?void 0:r.username)&&(s=e.user.user_metadata.username)}catch(e){}if(!s)try{let{data:e}=await a.OQ.from("profiles").select("username").eq("id",t).maybeSingle();(null==e?void 0:e.username)&&(s=e.username)}catch(e){}if(s||(s="用户_"+t.substring(0,6)),s.includes("@")){let e=s.split("@")[0];e&&(s=e)}let i=d.content.substring(0,20)+(d.content.length>20?"...":"");await c({userId:d.user_id,type:"like_comment",commentId:e,postId:d.post_id,actorId:t,message:"".concat(s,' 赞了你的评论: "').concat(i,'"')})}return null==o?void 0:o[0]}catch(e){throw console.error("评论点赞失败:",e),e}}async function b(e,t){try{let r="comment:".concat(e,":").concat(t);i.delete(r);let{error:n}=await a.OQ.from("comment_likes").delete().eq("comment_id",e).eq("user_id",t);if(n)throw n;return l("comment",e),!0}catch(e){throw console.error("取消评论点赞失败:",e),e}}}}]);